<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Irrigation Planner</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { font-family: sans-serif; background: #f8f9fa; padding: 20px; padding-bottom: 50px; }
        .container { max-width: 850px; margin: 0 auto; }
        
        /* Dashboard Card Styles */
        .dash-card { border: none; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* Task Card Styles */
        .task-card {
            background: #ffffff; 
            border-left: 5px solid #2ecc71;
            padding: 15px; 
            margin-bottom: 12px; 
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
        }
        .task-card.warning { border-left-color: #f39c12; background: #fffdf5; }
        
        .btn-back { display: inline-block; margin-bottom: 20px; text-decoration: none; color: #6c757d; font-weight: 500; }
        .btn-back:hover { color: #343a40; }

        /* Accordion Styles */
        .accordion-button:not(.collapsed) { background-color: #e9ecef; color: #333; }
        .accordion-button:focus { box-shadow: none; border-color: rgba(0,0,0,.125); }

        /* --- PRINT FOR FIELD STYLES --- */
        @media print {
            /* 1. Hide interactive elements and heavy colors to save ink */
            .btn, .btn-back, .accordion, .dash-card { display: none !important; }
            
            /* 2. Reset page layout */
            body, .container { background: white; padding: 0; margin: 0; max-width: 100%; }
            h2 { border-bottom: 2px solid #000 !important; padding-bottom: 10px; margin-bottom: 20px; }
            
            /* 3. Style the Task Cards for Paper */
            .task-card {
                border: 1px solid #ccc;
                border-left: 5px solid #000 !important; /* Black border for contrast */
                box-shadow: none;
                break-inside: avoid; /* Don't cut a task in half across pages */
                margin-bottom: 15px;
            }
            
            /* 4. Add a physical "Checkbox" for the worker */
            .task-card::after {
                content: "‚ñ¢ Done"; /* Adds a box and text */
                font-size: 1.2em;
                font-weight: bold;
                border: 2px solid #000;
                padding: 5px 15px;
                border-radius: 4px;
                margin-left: 20px;
            }
            
            /* Add a Footer */
            #task-list::after {
                content: "Generated by Smart Irrigation System | Worker Signature: __________________";
                display: block;
                margin-top: 50px;
                font-size: 0.8em;
                color: #555;
                border-top: 1px solid #ccc;
                padding-top: 10px;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <a href="/" class="btn-back mb-0"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>

        <div class="d-flex gap-2" id="language-section">
            <select id="languageSelect" class="form-select form-select-sm" style="width: auto; cursor: pointer;">
                <option value="en">English</option>
                <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
                <option value="mr">‡§Æ‡§∞‡§æ‡§†‡•Ä</option>
                <option value="kn">‡≤ï‡≤®‡≥ç‡≤®‡≤°</option>
                <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</option>
                <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</option>
            </select>
            <button onclick="window.print()" class="btn btn-dark">
            <i class="fas fa-print"></i> Print Field Sheet
            </button>
        </div>
    </div>
    
    <h2 class="mb-4 text-dark border-bottom pb-2">üìÖ Weekly Irrigation Schedule</h2>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card bg-primary text-white dash-card mb-3">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase mb-0" style="opacity:0.8">Total Water Planned</h6>
                        <h2 class="fw-bold mb-0"><span id="totalWater">0</span> L</h2>
                    </div>
                    <i class="fas fa-hand-holding-water fa-3x" style="opacity:0.3"></i>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card bg-success text-white dash-card mb-3">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase mb-0" style="opacity:0.8">Pending Tasks</h6>
                        <h2 class="fw-bold mb-0"><span id="pendingTasks">0</span></h2>
                    </div>
                    <i class="fas fa-clipboard-list fa-3x" style="opacity:0.3"></i>
                </div>
            </div>
        </div>
    </div>

    <h5 class="text-muted mb-3">Upcoming Tasks</h5>
    <div id="task-list" class="mb-5">
        <div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div></div>
    </div>

    <div class="card dash-card mt-4">
        <div class="card-header bg-secondary text-white">
            <i class="fas fa-history"></i> Irrigation History
        </div>
        <div class="card-body p-0">
            <div class="accordion accordion-flush" id="historyAccordion">
                </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    (function() {
        const languageSelect = document.getElementById('languageSelect');

        // IDs of text to translate in this page
        const translatableIds = [
            'lbl_back',
            'lbl_title',
            'lbl_total_water',
            'lbl_pending_tasks',
            'lbl_upcoming',
            'lbl_history'
        ];

        function collectTexts() {
            const texts = {};
            translatableIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) texts[id] = el.innerText.trim();
            });
            return texts;
        }

        function applyTranslations(obj) {
            for (const id in obj) {
                const el = document.getElementById(id);
                if (el) el.innerText = obj[id];
            }
        }

        async function translateTo(lang) {
            const texts = collectTexts();
            try {
                const res = await fetch('/translate_texts', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ lang, texts })
                });
                if (!res.ok) throw new Error('Translate API error');
                const translated = await res.json();
                applyTranslations(translated);
            } catch (err) {
                console.error('Translation error:', err);
            }
        }

        // Event Listener for Dropdown
        languageSelect.addEventListener('change', function() {
            const lang = this.value;
            localStorage.setItem('ui_lang', lang); // Save preference
            translateTo(lang);
        });

        // Load saved preference on startup
        window.addEventListener('DOMContentLoaded', function() {
            const saved = localStorage.getItem('ui_lang') || 'en';
            languageSelect.value = saved;
            // Small delay to ensure elements render
            setTimeout(() => translateTo(saved), 200);
        });
    })();
</script>


<script>
    // --- 1. Main Load Function ---
    document.addEventListener('DOMContentLoaded', () => {
        fetch('/scheduler/get_tasks')
            .then(res => res.json())
            .then(tasks => {
                const activeList = document.getElementById('task-list');
                const historyContainer = document.getElementById('historyAccordion'); 
                
                // Reset containers
                if(activeList) activeList.innerHTML = "";
                if(historyContainer) historyContainer.innerHTML = "";

                // --- Filter Tasks ---
                const activeTasks = tasks.filter(t => t.status !== 'Completed');
                const historyTasks = tasks.filter(t => t.status === 'Completed');

                // --- Update Dashboard Numbers (Calculated from Active Tasks only) ---
                let totalLiters = 0;
                activeTasks.forEach(t => totalLiters += parseFloat(t.amount || 0));
                
                const totalEl = document.getElementById('totalWater');
                const pendingEl = document.getElementById('pendingTasks');
                if (totalEl) totalEl.innerText = totalLiters.toFixed(1);
                if (pendingEl) pendingEl.innerText = activeTasks.length;

                // --- Render Active Tasks ---
                if(activeTasks.length === 0) { 
                    activeList.innerHTML = "<p class='text-muted text-center py-3'>No upcoming tasks scheduled.</p>"; 
                } else {
                    activeTasks.forEach(task => {
                        const warn = task.warning ? `<br><small style="color:#d35400"><i class="fas fa-exclamation-triangle"></i> ${task.warning}</small>` : '';
                        const style = task.warning ? 'warning' : '';
                        
                        activeList.innerHTML += `
                            <div class="task-card ${style}">
                                <div>
                                    <strong>${task.date} @ ${task.time}</strong> <br>
                                    Crop: <b>${task.crop}</b> | Amount: ${task.amount} L
                                    ${warn}
                                </div>
                                <button class="btn btn-success btn-sm" onclick="completeTask(${task.id})">
                                    <i class="fas fa-check"></i> Done
                                </button>
                            </div>
                        `;
                    });
                }

                // --- Render History Tasks (Grouped by Week) ---
                renderHistory(historyTasks, historyContainer);
            })
            .catch(error => console.error("Error loading tasks:", error));
    });

    // --- 2. Helper Functions for Date Grouping ---

    function getMonday(d) {
        d = new Date(d);
        var day = d.getDay(),
            diff = d.getDate() - day + (day == 0 ? -6 : 1); // Adjust when day is sunday
        return new Date(d.setDate(diff));
    }

    function formatDateShort(dateObj) {
        return dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    // --- 3. Render History Logic ---

    function renderHistory(historyTasks, container) {
        if (!container) return; 

        if (historyTasks.length === 0) {
            container.innerHTML = "<div class='p-3 text-muted text-center'>No history records found.</div>";
            return;
        }

        // Group by Week
        const grouped = {};
        historyTasks.forEach(task => {
            const taskDate = new Date(task.date);
            const monday = getMonday(taskDate);
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);

            const weekKey = `${formatDateShort(monday)} - ${formatDateShort(sunday)}`;
            if (!grouped[weekKey]) grouped[weekKey] = [];
            grouped[weekKey].push(task);
        });

        // Generate Accordion HTML
        let index = 0;
        for (const [weekRange, tasks] of Object.entries(grouped)) {
            index++;
            const totalLiters = tasks.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0).toFixed(1);
            
            const html = `
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading${index}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}">
                            <div class="d-flex w-100 justify-content-between me-3">
                                <span><strong>Week:</strong> ${weekRange}</span>
                                <span class="badge bg-secondary rounded-pill">${tasks.length} Tasks (${totalLiters} L)</span>
                            </div>
                        </button>
                    </h2>
                    <div id="collapse${index}" class="accordion-collapse collapse" data-bs-parent="#historyAccordion">
                        <div class="accordion-body p-0">
                            <ul class="list-group list-group-flush">
                                ${tasks.map(t => `
                                    <li class="list-group-item d-flex justify-content-between align-items-center ps-4">
                                        <div>
                                            <i class="fas fa-check-double text-success me-2"></i>
                                            <strong>${t.date}</strong>: ${t.crop}
                                            <span class="text-muted small">(${t.amount} L)</span>
                                        </div>
                                        <button class="btn btn-sm text-danger" onclick="deleteTask(${t.id})" title="Delete Record">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += html;
        }
    }

    // --- 4. Action Functions ---

    function completeTask(id) {
        fetch('/scheduler/complete_task', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({id: id})
        }).then(() => location.reload());
    }

    function deleteTask(id) {
        if(!confirm("Permanently delete this record?")) return;
        fetch('/scheduler/delete_task', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({id: id})
        }).then(() => location.reload());
    }
</script>

</body>
</html>